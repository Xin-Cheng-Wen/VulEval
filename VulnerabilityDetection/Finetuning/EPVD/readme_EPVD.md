# EPVD: Vulnerability Detection by Decomposing Code into Syntax-Based Execution Paths

## Task Definition
Given one code as the input, the task is to do binary classification (0/1), where 1 stands for vulnerability code and 0 for non-vulnerability code. Models are evaluated by F1 score.


## Directory Structure
- code: source code of EPVD and scripts to run experiments
- dataset: our dataset 
- evaluator: source code of evaluation, including accuracy, precision, recall, and F1-score
- models: the pre-trained CodeBERT model, including config.json, pytorch_model.bin, special_tokens_map.json, and tokenizer_config.json
- parserTool: the tool of Tree-sitter
- results: the results of all experiments, including the different path selection methods, different numbers of selected paths, and different path fusion methods.


## Prepare Requirements
- Python: 3.8
- Pytorch: 1.10.0+cu111
- networkx: 2.8.5
- numpy: 1.22.3
- scikit-learn: 1.1.1
- scipy: 1.8.1
- tree-sitter: 0.20.0

### Tree-sitter (optional)
Before running the program, if the built file "parserTool/my-languages.so" doesn't work for you, please rebuild as the following command and modify the file path in the parse.py file:

```shell
cd parserTool
bash build.sh
cd ..
```


## Dataset
We merge three existing high-quality dataset, i.e. the REVEAL dataset, the Big-Vul dataset, and the Devign dataset. Further, we randomly split the merged dataset into training, validation and test sets with 80%, 10%, and 10%. The processed dataset can be downloaded from [website](https://drive.google.com/drive/folders/1MS56wGCMme3YDR0lyFTkLnpII4raemAP?usp=sharing) to "dataset" folder.

### Data Format
train_cdata.jsonl/valid_cdata.jsonl/test_cdata.jsonl are stored in jsonlines format. Each line in the uncompressed file represents one function. One row is illustrated below.
- **func:** the function
- **target:** the label of the funciton
- **idx:** index of the example

### Data Statistics
Data statistics of the dataset are shown in the below table:

|         | #Examples |
| -----   | :-------: |
| Non-Vul |  207,059  |
| Vul     |   24,241  |


## Train
We use 4*NVIDIA3090-24G* to fine-tune and 10% valid data to evaluate.
```shell
python run.py --output_dir=./saved_models --model_type=roberta --tokenizer_name=../models/codebert --model_name_or_path=../models/codebert --do_train --train_data_file=../dataset/cdata/nobalance/train_cdata.jsonl --eval_data_file=../dataset/cdata/nobalance/valid_cdata.jsonl --test_data_file=../dataset/cdata/nobalance/test_cdata.jsonl --epoch 8 --block_size 400 --train_batch_size 40 --eval_batch_size 64 --learning_rate 2e-5 --max_grad_norm 1.0 --evaluate_during_training --seed 123456 --cnn_size 128 --filter_size 3 --d_size 128 --pkl_file=short_3path_cdata_nobalance.pkl
```


## Inference
We use full test data for inference. 
```shell
python run.py --output_dir=./saved_models --model_type=roberta --tokenizer_name=../models/codebert --model_name_or_path=../models/codebert --do_eval --do_test --train_data_file=../dataset/cdata/nobalance/train_cdata.jsonl --eval_data_file=../dataset/cdata/nobalance/valid_cdata.jsonl --test_data_file=../dataset/cdata/nobalance/test_cdata.jsonl --epoch 8 --block_size 400 --train_batch_size 40 --eval_batch_size 64 --learning_rate 2e-5 --max_grad_norm 1.0 --evaluate_during_training --seed 123456 --cnn_size 128 --filter_size 3 --d_size 128 --pkl_file=short_3path_cdata_nobalance.pkl
```


## Evaluation 
```shell
python ../evaluator/evaluator.py -a ../dataset/cdata/nobalance/test_cdata.jsonl -p saved_models/predictions.txt
```

## The script of EPVD and EPVD's variants

### The EPVD script
```
cd code
bash ./test_cdata_3path.sh
```

### Different path selection methods
```shell
cd code
bash ./test_cdata_pathmethod.sh
```

### Different numbers of selected paths
```shell
cd code
bash ./test_cdata_pathnumber.sh
```

### Different path fusion methods
```shell
cd code
bash ./test_cdata_pathfuse.sh
```

## Result
The results on the test set are shown as below:

| Methods  |    Precision    |    Recall    |    F1-Score    |
| -------- |    :-------:    |    :----:    |    :------:    |
| [CodeBERT](https://arxiv.org/pdf/2002.08155.pdf) | 54.40 | 46.78 | 50.30 |
| **EPVD**     | **66.53** |**66.86** |**66.69** |


