import os, shutil

def valid_name(x: str):
    head = ['train', 'valid', 'test']
    return any([x.startswith(h) for h in head])

if os.path.isdir('parsed_code'):
    shutil.rmtree('parsed_code')

os.makedirs('parsed_code')
PATH = '../code-slicer/joern'
print(len(list(filter(valid_name, os.listdir(PATH)))))

for file in sorted(os.listdir(PATH)):
    OLD_DIR = f'{PATH}/{file}'
    if valid_name(file):
        print(file)
        OLD_DIR_FULL = f'{OLD_DIR}/tmp{file}/{file}'
        DIR = f'parsed_code/{file}'

        os.makedirs(DIR, exist_ok=True)
        try:
            os.rename(f'{OLD_DIR_FULL}/edges.csv', f'{DIR}/edges.csv')
            os.rename(f'{OLD_DIR_FULL}/nodes.csv', f'{DIR}/nodes.csv')
        except:
            shutil.rmtree(DIR)

        shutil.rmtree(OLD_DIR)

    elif file.startswith('tmp') and os.path.isdir(OLD_DIR):
        print(f'Removing {OLD_DIR}')
        shutil.rmtree(OLD_DIR)
